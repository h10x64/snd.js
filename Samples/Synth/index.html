<html>
    <head>
        <title>snd.js Demo - snd.Synth.js -</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <script src="../../dist/snd.js"></script>
        <script>
            // snd.jsを初期化
            snd.init();
            // 13音同時発音可能なSynthクラスを作る。
            var SYNTH = new snd.Synth(
                    "シンセ",   // id: この音源のID
                    13,         // polyphony: 同時発音可能数
                    null,       // waveForm: 波形の形
                    null        // envelope: エンベロープ
            );
            snd.MASTER.connectAudioUnit(SYNTH.id, SYNTH);

            // キーコードの定数
            var KEY_Z = 90;  // z
            var KEY_S = 83; // s
            var KEY_X = 88;  // x
            var KEY_D = 68; // d
            var KEY_C = 67;  // c
            var KEY_V = 86;  // v
            var KEY_G = 71; // g
            var KEY_B = 66;  // b
            var KEY_H = 72; // h
            var KEY_N = 78;  // n
            var KEY_J = 74; // j
            var KEY_M = 77;  // m
            var KEY_COMMA = 188; // ,

            // 押しているキー
            var PRESS_KEY = {
                C4: false,
                C4s: false,
                D4: false,
                D4s: false,
                E4: false,
                F4: false,
                F4s: false,
                G4: false,
                G4s: false,
                A4: false,
                A4s: false,
                B4: false,
                C5: false
            };
            
            var KEY = function(offColor, onColor) {
                this.img = null;
                this.offColor = offColor;
                this.onColor = onColor;
            };
            KEY.prototype.on = function() {
                if (this.img != null) {
                    this.img.style.fill = this.onColor;
                }
            };
            KEY.prototype.off = function() {
                if (this.img != null) {
                    this.img.style.fill = this.offColor;
                }
            };

            // キーボード
            var KEYBOARD = {
                img: null,
                C4: new KEY("#FFF", "#EEE"),
                C4s: new KEY("#222", "#000"),
                D4: new KEY("#FFF", "#EEE"),
                D4s: new KEY("#222", "#000"),
                E4: new KEY("#FFF", "#EEE"),
                F4: new KEY("#FFF", "#EEE"),
                F4s: new KEY("#222", "#000"),
                G4: new KEY("#FFF", "#EEE"),
                G4s: new KEY("#222", "#000"),
                A4: new KEY("#FFF", "#EEE"),
                A4s: new KEY("#222", "#000"),
                B4: new KEY("#FFF", "#EEE"),
                C5: new KEY("#FFF", "#EEE"),
                
                setSVG: function(svg) {
                    this.img = svg;
                    this.C4.img = svg.getElementById("C4");
                    this.C4.img.onmousedown = function(){window.onkeydown({keyCode:KEY_Z})};
                    this.C4.img.onmouseup = function(){window.onkeyup({keyCode:KEY_Z})};
                    this.C4s.img = svg.getElementById("C4s");
                    this.C4s.img.onmousedown = function(){window.onkeydown({keyCode:KEY_S})};
                    this.C4s.img.onmouseup = function(){window.onkeyup({keyCode:KEY_S})};
                    this.D4.img = svg.getElementById("D4");
                    this.D4.img.onmousedown = function(){window.onkeydown({keyCode:KEY_X})};
                    this.D4.img.onmouseup = function(){window.onkeyup({keyCode:KEY_X})};
                    this.D4s.img = svg.getElementById("D4s");
                    this.D4s.img.onmousedown = function(){window.onkeydown({keyCode:KEY_D})};
                    this.D4s.img.onmouseup = function(){window.onkeyup({keyCode:KEY_D})};
                    this.E4.img = svg.getElementById("E4");
                    this.E4.img.onmousedown = function(){window.onkeydown({keyCode:KEY_C})};
                    this.E4.img.onmouseup = function(){window.onkeyup({keyCode:KEY_C})};
                    this.F4.img = svg.getElementById("F4");
                    this.F4.img.onmousedown = function(){window.onkeydown({keyCode:KEY_V})};
                    this.F4.img.onmouseup = function(){window.onkeyup({keyCode:KEY_V})};
                    this.F4s.img = svg.getElementById("F4s");
                    this.F4s.img.onmousedown = function(){window.onkeydown({keyCode:KEY_G})};
                    this.F4s.img.onmouseup = function(){window.onkeyup({keyCode:KEY_G})};
                    this.G4.img = svg.getElementById("G4");
                    this.G4.img.onmousedown = function(){window.onkeydown({keyCode:KEY_B})};
                    this.G4.img.onmouseup = function(){window.onkeyup({keyCode:KEY_B})};
                    this.G4s.img = svg.getElementById("G4s");
                    this.G4s.img.onmousedown = function(){window.onkeydown({keyCode:KEY_H})};
                    this.G4s.img.onmouseup = function(){window.onkeyup({keyCode:KEY_H})};
                    this.A4.img = svg.getElementById("A4");
                    this.A4.img.onmousedown = function(){window.onkeydown({keyCode:KEY_N})};
                    this.A4.img.onmouseup = function(){window.onkeyup({keyCode:KEY_N})};
                    this.A4s.img = svg.getElementById("A4s");
                    this.A4s.img.onmousedown = function(){window.onkeydown({keyCode:KEY_J})};
                    this.A4s.img.onmouseup = function(){window.onkeyup({keyCode:KEY_J})};
                    this.B4.img = svg.getElementById("B4");
                    this.B4.img.onmousedown = function(){window.onkeydown({keyCode:KEY_M})};
                    this.B4.img.onmouseup = function(){window.onkeyup({keyCode:KEY_M})};
                    this.C5.img = svg.getElementById("C5");
                    this.C5.img.onmousedown = function(){window.onkeydown({keyCode:KEY_COMMA})};
                    this.C5.img.onmouseup = function(){window.onkeyup({keyCode:KEY_COMMA})};
                    
                    this.img.onkeydown = function(evt) {
                        window.onkeydown(evt);
                    };
                    this.img.onkeyup = function(evt) {
                        window.onkeyup(evt);
                    };
                }
            };

            window.onload = function() {
                var svgObj = document.getElementById("keyboard");
                var svg = (svgObj.contetntDocument != null) ? svgObj.contentDocument : svgObj.getSVGDocument();
                
                try {
                    KEYBOARD.setSVG(svg);
                } catch (exception) {
                    // NOP!!
                }

                window.onkeydown = function(evt) {
                    switch (evt.keyCode) {
                        case KEY_Z:// z(ド)
                            if (!PRESS_KEY['C4']) {
                                KEYBOARD.C4.on();
                                SYNTH.noteOn([{no: 0, freq: snd.util.noteToFrequency(4, 0)}]);
                                PRESS_KEY['C4'] = true;
                            }
                            break;
                        case KEY_S:// s(ド#)
                            if (!PRESS_KEY['C4s']) {
                                KEYBOARD.C4s.on();
                                SYNTH.noteOn([{no: 1, freq: snd.util.noteToFrequency(4, 1)}]);
                                PRESS_KEY['C4s'] = true;
                            }
                            break;
                        case KEY_X:// x(レ)
                            if (!PRESS_KEY['D4']) {
                                KEYBOARD.D4.on();
                                SYNTH.noteOn([{no: 2, freq: snd.util.noteToFrequency(4, 2)}]);
                                PRESS_KEY['D4'] = true;
                            }
                            break;
                        case KEY_D:// d(レ#)
                            if (!PRESS_KEY['D4s']) {
                                KEYBOARD.D4s.on();
                                SYNTH.noteOn([{no: 3, freq: snd.util.noteToFrequency(4, 3)}]);
                                PRESS_KEY['D4s'] = true;
                            }
                            break;
                        case KEY_C:// c(ミ)
                            if (!PRESS_KEY['E4']) {
                                KEYBOARD.E4.on();
                                SYNTH.noteOn([{no: 4, freq: snd.util.noteToFrequency(4, 4)}]);
                                PRESS_KEY['E4'] = true;
                            }
                            break;
                        case KEY_V:// v(ファ)
                            if (!PRESS_KEY['F4']) {
                                KEYBOARD.F4.on();
                                SYNTH.noteOn([{no: 5, freq: snd.util.noteToFrequency(4, 5)}]);
                                PRESS_KEY['F4'] = true;
                            }
                            break;
                        case KEY_G:// g(ファ#)
                            if (!PRESS_KEY['F4s']) {
                                KEYBOARD.F4s.on();
                                SYNTH.noteOn([{no: 6, freq: snd.util.noteToFrequency(4, 6)}]);
                                PRESS_KEY['F4s'] = true;
                            }
                            break;
                        case KEY_B:// b(ソ)
                            if (!PRESS_KEY['G4']) {
                                KEYBOARD.G4.on();
                                SYNTH.noteOn([{no: 7, freq: snd.util.noteToFrequency(4, 7)}]);
                                PRESS_KEY['G4'] = true;
                            }
                            break;
                        case KEY_H:// h(ソ#)
                            if (!PRESS_KEY['G4s']) {
                                KEYBOARD.G4s.on();
                                SYNTH.noteOn([{no: 8, freq: snd.util.noteToFrequency(4, 8)}]);
                                PRESS_KEY['G4s'] = true;
                            }
                            break;
                        case KEY_N:// n(ラ)
                            if (!PRESS_KEY['A4']) {
                                KEYBOARD.A4.on();
                                SYNTH.noteOn([{no: 9, freq: snd.util.noteToFrequency(4, 9)}]);
                                PRESS_KEY['A4'] = true;
                            }
                            break;
                        case KEY_J:// j(ラ#)
                            if (!PRESS_KEY['A4s']) {
                                KEYBOARD.A4s.on();
                                SYNTH.noteOn([{no: 10, freq: snd.util.noteToFrequency(4, 10)}]);
                                PRESS_KEY['A4s'] = true;
                            }
                            break;
                        case KEY_M:// m(シ)
                            if (!PRESS_KEY['B4']) {
                                KEYBOARD.B4.on();
                                SYNTH.noteOn([{no: 11, freq: snd.util.noteToFrequency(4, 11)}]);
                                PRESS_KEY['B4'] = true;
                            }
                            break;
                        case KEY_COMMA:// ,(ド)
                            if (!PRESS_KEY['C5']) {
                                KEYBOARD.C5.on();
                                SYNTH.noteOn([{no: 12, freq: snd.util.noteToFrequency(5, 0)}]);
                                PRESS_KEY['C5'] = true;
                            }
                            break;
                    }
                };

                window.onkeyup = function(evt) {
                    switch (evt.keyCode) {
                        case KEY_Z:// z(ド)
                            if (PRESS_KEY['C4']) {
                                KEYBOARD.C4.off();
                                SYNTH.noteOff([{no: 0}]);
                                PRESS_KEY['C4'] = false;
                            }
                            break;
                        case KEY_S:// s(ド#)
                            if (PRESS_KEY['C4s']) {
                                KEYBOARD.C4s.off();
                                SYNTH.noteOff([{no: 1}]);
                                PRESS_KEY['C4s'] = false;
                            }
                            break;
                        case KEY_X:// x(レ)
                            if (PRESS_KEY['D4']) {
                                KEYBOARD.D4.off();
                                SYNTH.noteOff([{no: 2}]);
                                PRESS_KEY['D4'] = false;
                            }
                            break;
                        case KEY_D:// d(レ#)
                            if (PRESS_KEY['D4s']) {
                                KEYBOARD.D4s.off();
                                SYNTH.noteOff([{no: 3}]);
                                PRESS_KEY['D4s'] = false;
                            }
                            break;
                        case KEY_C:// c(ミ)
                            if (PRESS_KEY['E4']) {
                                KEYBOARD.E4.off();
                                SYNTH.noteOff([{no: 4}]);
                                PRESS_KEY['E4'] = false;
                            }
                            break;
                        case KEY_V:// v(ファ)
                            if (PRESS_KEY['F4']) {
                                KEYBOARD.F4.off();
                                SYNTH.noteOff([{no: 5}]);
                                PRESS_KEY['F4'] = false;
                            }
                            break;
                        case KEY_G:// g(ファ#)
                            if (PRESS_KEY['F4s']) {
                                KEYBOARD.F4s.off();
                                SYNTH.noteOff([{no: 6}]);
                                PRESS_KEY['F4s'] = false;
                            }
                            break;
                        case KEY_B:// b(ソ)
                            if (PRESS_KEY['G4']) {
                                KEYBOARD.G4.off();
                                SYNTH.noteOff([{no: 7}]);
                                PRESS_KEY['G4'] = false;
                            }
                            break;
                        case KEY_H:// h(ソ#)
                            if (PRESS_KEY['G4s']) {
                                KEYBOARD.G4s.off();
                                SYNTH.noteOff([{no: 8}]);
                                PRESS_KEY['G4s'] = false;
                            }
                            break;
                        case KEY_N:// n(ラ)
                            if (PRESS_KEY['A4']) {
                                KEYBOARD.A4.off();
                                SYNTH.noteOff([{no: 9}]);
                                PRESS_KEY['A4'] = false;
                            }
                            break;
                        case KEY_J:// j(ラ#)
                            if (PRESS_KEY['A4s']) {
                                KEYBOARD.A4s.off();
                                SYNTH.noteOff([{no: 10}]);
                                PRESS_KEY['A4s'] = false;
                            }
                            break;
                        case KEY_M:// m(シ)
                            if (PRESS_KEY['B4']) {
                                KEYBOARD.B4.off();
                                SYNTH.noteOff([{no: 11}]);
                                PRESS_KEY['B4'] = false;
                            }
                            break;
                        case KEY_COMMA:// ,(ド)
                            if (PRESS_KEY['C5']) {
                                KEYBOARD.C5.off();
                                SYNTH.noteOff([{no: 12}]);
                                PRESS_KEY['C5'] = false;
                            }
                            break;
                    }
                };
            }
        </script>
    </head>
    <body>
        鍵盤をクリック、または、キーボードを押すことで音が出ます。<br/>
        <br/>
        <object type="image/svg+xml" data="../img/keyboard.svg" id="keyboard"></object><br/>
        <br/>
        <font size="2">
        注意: <br/>
        ローカル環境で実行する場合は、svgの取得ができないためキーボードクリックイベントが動作しません。<br/>
        ローカルでキーボードを動作させるためには、ブラウザの設定を変更する必要があります。<br/>
        設定の内容は<a href="https://github.com/mrdoob/three.js/wiki/How-to-run-things-locally#change-local-files-security-policy">How to run things locally - mrdoob/three.js Wiki</a>を参照してください。
        例: Firefoxの場合、URLにabout:configと入力してに設定画面にアクセスし、security.fileuri.strict_origin_policyをfalseに設定<br/>
        </font>
        <br/>
        キーボードと鍵盤の対応表<br/>
        <table border="1">
            <tr><td>Key</td><td>Note</td></tr>
            <tr><td>Z</td><td>C4</td></tr>
            <tr><td>S</td><td>C4#</td></tr>
            <tr><td>X</td><td>D4</td></tr>
            <tr><td>D</td><td>D4#</td></tr>
            <tr><td>C</td><td>E4</td></tr>
            <tr><td>V</td><td>F4</td></tr>
            <tr><td>G</td><td>F4#</td></tr>
            <tr><td>B</td><td>G4</td></tr>
            <tr><td>H</td><td>G4#</td></tr>
            <tr><td>N</td><td>A4</td></tr>
            <tr><td>J</td><td>A4#</td></tr>
            <tr><td>M</td><td>B4</td></tr>
            <tr><td>,</td><td>C5</td></tr>
        </table>
    </body>
</html>
