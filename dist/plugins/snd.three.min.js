/* snd.js - The Sound Library for JavaScript with WebAudioAPI - v.0.85 */
/**
 * snd.js
 * 
 * The MIT License (MIT)
 * copyright (c) 2014 N_H <h.10x64@gmail.com>
 * 
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 * 
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 * 
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 * THE SOFTWARE.
 * 
 **/snd.three={version:.1,beta:!0},snd.three.mode={},snd.three.mode.NONE=0,snd.three.mode.POSTURE=1,snd.three.mode.DOPPLER=2,snd.three.mode.DELAY=4,snd.three.mode.ALL=7,snd.Listener=function(a){snd.PosDir.apply(this,arguments),this.listener=a,null!=a&&this.listener.setOrientation(this.dir.x,this.dir.y,this.dir.z,this.up.x,this.up.y,this.up.z)},snd.Listener.prototype=Object.create(snd.PosDir.prototype),snd.Listener.prototype.constructor=snd.Listener,snd.Listener.prototype.setListener=function(a){this.listener=a,this.setPosition(this.pos.x,this.pos.y,this.pos.z),this.setOrientation(this.dir.x,this.dir.y,this.dir.z,this.up.x,this.up.y,this.up.z)},snd.Listener.prototype.resetListener=function(){this.setListener(null)},snd.Listener.prototype.setPosition=function(a,b,c){snd.PosDir.prototype.setPosition.call(this,a,b,c),null!=this.listener&&this.listener.setPosition(snd.SOUND_ENVIRONMENT.unit*this.pos.x,snd.SOUND_ENVIRONMENT.unit*this.pos.y,snd.SOUND_ENVIRONMENT.unit*this.pos.z)},snd.Listener.prototype.setOrientation=function(a,b,c,d,e,f){snd.PosDir.prototype.setOrientation.call(this,a,b,c,d,e,f),null!=this.listener&&this.listener.setOrientation(this.dir.x,this.dir.y,this.dir.z,this.up.x,this.up.y,this.up.z)},snd.Listener.prototype.setOrientationBySpherical=function(a,b){snd.PosDir.prototype.setOrientationBySpherical.call(this,a,b),null!=this.listener&&this.listener.setOrientation(this.dir.x,this.dir.y,this.dir.z,this.up.x,this.up.y,this.up.z)},snd.Listener.prototype.setVelocity=function(a,b,c){null!=this.listener&&this.listener.setVelocity(snd.SOUND_ENVIRONMENT.unit*a,snd.SOUND_ENVIRONMENT.unit*b,snd.SOUND_ENVIRONMENT.unit*c)},snd.SoundEnvironment=function(){this.now=0,this.listener=snd.AUDIO_CONTEXT.listener,this.listeners={},this.soundNodes={},this.unit=1,this.cameras={},this.attaches={},this.linkMap={}},snd.SoundEnvironment.prefix={kilo:1e3,hecto:100,deca:10,metre:1,deci:.1,centi:.01,milli:.001},snd.SoundEnvironment.DEFAULT_BUFFER_MAX=1800,snd.SoundEnvironment.prototype.setUnitPrefix=function(a){this.unit=a},snd.SoundEnvironment.prototype.addListener=function(a,b){this.listeners[a]=new snd.PosDirTime(b,1)},snd.SoundEnvironment.prototype.removeListener=function(a){null!=this.soundNodes[a]&&delete this.soundNodes[a]},snd.SoundEnvironment.prototype.addSoundNode=function(a,b){this.soundNodes[a]=new snd.PosDirTime(b)},snd.SoundEnvironment.prototype.removeSoundNode=function(a){null!=this.soundNodes[a]&&delete this.soundNodes[a]},snd.SoundEnvironment.prototype.update=function(a){if(this.now>a)throw new snd.SoundEnvironment.UpdateError(this,"time < this.now (time: "+a+", this.now: "+this.now);for(var b in this.listeners)this.listeners[b].update(a);for(var b in this.soundNodes)this.soundNodes[b].update(a)},snd.SoundEnvironment.UpdateError=function(a,b){this._this=a,this.message=b},snd.PosDirTime=function(a,b){this.data=a,this.history=[],this.bufferMax=b},snd.PosDirTime.prototype.update=function(a){0==this.history.length&&this.history.push({time:0,posture:Object.create(this.data)}),this.history.length>this.bufferMax&&this.history.splice(0,1),this.history.push({time:a,posture:Object.create(this.data)})},snd.PosDirTime.prototype.getPosture=function(a){var b=this.search(a);if(null==b)return null;if(b.left==b.right)return this.history[b.left];var c=this.history[c],d=this.history[d],e=(a-c.time)/(d.time-c.time);return snd.PosDir.interpolation(c,d,e)},snd.PosDirTime.prototype.search=function(a){if(this.history.length<=0)return null;if(1==this.history.length)return{left:0,right:0};if(this.history[this.history.length-1].time<a)return{left:this.history.length-1,right:this.history.legnth-1};if(this.history[0].time>a)return{left:0,right:0};for(var b=0,c=this.history.length-1,d=Math.floor(c/2);;)if(d=Math.floor((a-this.history[b].time)*(c-b)/(this.history[c].time-this.history[b].time))+b,this.history[d].time<a){if(this.history[d+1]>a)return{left:d,right:d+1};b=d+1}else{if(!(this.history[d].time>a))return{left:d,right:d};if(this.history[d-1].time<a)return{left:d-1,right:d};c=d-1}},snd.SoundNode=function(){snd.AudioUnit.apply(this,arguments),snd.PosDir.apply(this,arguments),this.gain=snd.AUDIO_CONTEXT.createGain(),this.pannerNode=snd.AUDIO_CONTEXT.createPanner(),this.gain.connect(this.pannerNode)},snd.SoundNode.prototype=Object.create(snd.AudioUnit.prototype),snd.SoundNode.prototype.constructor=snd.SoundNode,snd.SoundNode.prototype.connect=function(a){snd.AudioUnit.prototype.connect.apply(this,arguments),this.pannerNode.connect(a.isAudioUnit?a.getConnector():a)},snd.SoundNode.prototype.disconnect=function(a){snd.AudioUnit.prototype.disconnect.apply(this,arguments),this.pannerNode.disconnect(a.isAudioUnit?a.getConnector():a)},snd.SoundNode.prototype.getConnector=function(){return this.gain},snd.SoundNode.prototype.getGain=function(){return this.gain},snd.SoundNode.start=function(){},snd.SoundNode.stop=function(){},snd.SoundNode.pause=function(){},snd.SoundNode.prototype.setPosition=function(a,b,c){snd.PosDir.prototype.setPosition.call(this,a,b,c),this.pannerNode.setPosition(snd.SOUND_ENVIRONMENT.unit*this.pos.x,snd.SOUND_ENVIRONMENT.unit*this.pos.y,snd.SOUND_ENVIRONMENT.unit*this.pos.z)},snd.SoundNode.prototype.setDir=function(a,b,c){snd.PosDir.prototype.setDir.call(this,a,b,c),this.pannerNode.setOrientation(this.dir.x,this.dir.y,this.dir.z)},snd.SoundNode.prototype.setUp=function(a,b,c){snd.PosDir.prototype.setUp.call(this,a,b,c)},snd.SoundNode.prototype.setOrientation=function(a,b,c,d,e,f){snd.PosDir.prototype.setOrientation.call(this,a,b,c,d,e,f),this.pannerNode.setOrientation(this.dir.x,this.dir.y,this.dir.z)},snd.SoundNode.prototype.setVelocity=function(a,b,c){this.pannerNode.setVelocity(snd.SOUND_ENVIRONMENT.unit*a,snd.SOUND_ENVIRONMENT.unit*b,snd.SOUND_ENVIRONMENT.unit*c)},snd.BufferSoundNode=function(a,b){snd.SoundNode.apply(this,arguments),this.source=null==b?new snd.BufferSource(a+"_src"):b,this.source.connect(this)},snd.BufferSoundNode.prototype=Object.create(snd.SoundNode.prototype),snd.BufferSoundNode.prototype.constructor=snd.BufferSoundNode,snd.BufferSoundNode.prototype.setAudioBuffer=function(a){this.source.setAudioBuffer(a)},snd.BufferSoundNode.prototype.start=function(a,b,c){this.source.start(a,b,c)},snd.BufferSoundNode.prototype.stop=function(a){this.source.stop(a)},snd.BufferSoundNode.prototype.setLoop=function(a){this.source.setLoop(a)},snd.BufferSoundNode.prototype.getLoop=function(){return this.source.getLoop()},snd.BufferSoundNode.prototype.setLoopStart=function(a){this.source.setLoopStart(a)},snd.BufferSoundNode.prototype.getLoopStart=function(){return this.source.getLoopStart()},snd.BufferSoundNode.prototype.setLoopEnd=function(a){this.source.setLoopEnd(a)},snd.BufferSoundNode.prototype.getLoopEnd=function(){return this.source.getLoopEnd()},snd.BufferSoundNode.prototype.addOnEndedEventListener=function(a){this.source.addOnEndedEventListener(a)},snd.BufferSoundNode.prototype.removeOnEndedEventListener=function(a){return this.source.removeOnEndedEventListener(a)},snd.MediaElementAudioNode=function(a,b){snd.SoundNode.apply(this,arguments),this.source=b,this.source.connect(this),Object.defineProperties(this,{src:{enumerable:!0,get:function(){return this.source.src},set:function(a){this.source.src=a}}})},snd.MediaElementAudioNode.prototype=Object.create(snd.SoundNode.prototype),snd.MediaElementAudioNode.prototype.constructor=snd.MediaElementAudioNode,snd.MediaElementAudioNode.prototype.load=function(){this.source.load()},snd.MediaElementAudioNode.prototype.start=function(){this.source.start()},snd.MediaElementAudioNode.prototype.pause=function(){this.source.pause()},snd.MediaElementAudioNode.prototype.stop=function(){this.source.pause()},snd.MediaElementAudioNode.prototype.setLoop=function(a){this.source.setLoop(a)},snd.MediaElementAudioNode.prototype.addOnPlayEventListener=function(a){this.source.addOnPlayEventListener(a)},snd.MediaElementAudioNode.prototype.removeOnPlayEventListener=function(a){return this.source.removeOnPlayEventListener(a)},snd.MediaElementAudioNode.prototype.addOnPauseEventListener=function(a){this.source.addOnPauseEventListener(a)},snd.MediaElementAudioNode.prototype.removeOnPauseEventListener=function(a){return this.source.removeOnPauseEventListener(a)},snd.MediaElementAudioNode.prototype.addOnEndedEventListener=function(a){this.source.addOnEndedEventListener(a)},snd.MediaElementAudioNode.prototype.removeOnEndedEventListener=function(a){return this.source.removeOnEndedEventListener(a)},snd.MediaElementAudioNode.prototype.addOnAbortEventListener=function(a){this.source.addOnAbortEventListener(a)},snd.MediaElementAudioNode.prototype.removeOnAbortEventListener=function(a){return this.source.removeOnAbortEventListener(a)},snd.MediaElementAudioNode.prototype.addOnCanPlayEventListener=function(a){this.source.addOnCanPlayEventListener(a)},snd.MediaElementAudioNode.prototype.removeOnCanPlayEventListener=function(a){return this.source.removeOnCanPlayEventListener(a)},snd.MediaElementAudioNode.prototype.addOnCanPlayThroughEventListener=function(a){this.source.addOnCanPlayThroughEventListener(a)},snd.MediaElementAudioNode.prototype.removeOnCanPlayThroughEventListener=function(a){return this.source.removeOnCanPlayThroughEventListener(a)},snd.MediaElementAudioNode.prototype.addOnDurationChangeEventListener=function(a){this.source.addOnDurationChangeEventListener(a)},snd.MediaElementAudioNode.prototype.removeOnCanPlayThroughEventListener=function(a){return this.source.removeOnCanPlayEventListener(a)},snd.MediaElementAudioNode.prototype.addOnEmptiedEventListener=function(a){this.source.addOnEmptiedEventListener(a)},snd.MediaElementAudioNode.prototype.removeOnEmptiedEventListener=function(a){return this.source.removeOnEmptiedEventListener(a)},snd.MediaElementAudioNode.prototype.addOnErrorEventListener=function(a){this.source.addOnErrorEventListener(a)},snd.MediaElementAudioNode.prototype.removeOnErrorEventListener=function(a){return this.source.removeOnErrorEventListener(a)},snd.MediaElementAudioNode.prototype.addOnLoadedDataEventListener=function(a){this.source.addOnLoadedDataEventListener(a)},snd.MediaElementAudioNode.prototype.removeOnLoadedDataEventListener=function(a){return this.source.removeOnLoadedDataEventListener(a)},snd.MediaElementAudioNode.prototype.addOnLoadedMetadataEventListener=function(a){this.source.addOnLoadedMetadataEventListener(a)},snd.MediaElementAudioNode.prototype.removeOnLoadedMetaDataEventListener=function(a){return this.source.removeOnLoadedMetaDataEventListener(a)},snd.MediaElementAudioNode.prototype.addOnLoadStartEventListener=function(a){this.source.addOnLoadStartEventListener(a)},snd.MediaElementAudioNode.prototype.removeOnLoadStartEventListener=function(a){return this.source.removeOnLoadStartEventListener(a)},snd.MediaElementAudioNode.prototype.addOnPlayingEventListener=function(a){this.source.addOnPlayingEventListener(a)},snd.MediaElementAudioNode.prototype.removeOnPlayingEventListener=function(a){return this.source.removeOnPlayingEventListener(a)},snd.MediaElementAudioNode.prototype.addOnProgressEventListener=function(a){this.source.addOnProgressEventListener(a)},snd.MediaElementAudioNode.prototype.removeOnProgressEventListener=function(a){return this.source.removeOnProgressEventListener(a)},snd.MediaElementAudioNode.prototype.addOnRateChangeEventListener=function(a){this.source.addOnRateChangeEventListener(a)},snd.MediaElementAudioNode.prototype.removeOnRateChangeEventListener=function(a){return this.source.removeOnRateChangeEventListener(a)},snd.MediaElementAudioNode.prototype.addOnSeekedEventListener=function(a){this.source.addOnSeekedEventListener(a)},snd.MediaElementAudioNode.prototype.removeOnSeekedEventListener=function(a){return this.source.removeOnSeekedEventListener(a)},snd.MediaElementAudioNode.prototype.addOnSeekingEventListener=function(a){this.source.addOnSeekingEventListener(a)},snd.MediaElementAudioNode.prototype.removeOnSeekingEventListener=function(a){return this.source.removeOnSeekingEventListener(a)},snd.MediaElementAudioNode.prototype.addOnStalledEventListener=function(a){this.source.addOnStalledEventListener(a)},snd.MediaElementAudioNode.prototype.removeOnStalledEventListener=function(a){return this.source.removeOnStalledEventListener(a)},snd.MediaElementAudioNode.prototype.addOnSuspendEventListener=function(a){this.source.addOnSuspendEventListener(a)},snd.MediaElementAudioNode.prototype.removeOnSuspendEventListener=function(a){return this.source.removeOnSuspendEventListener(a)},snd.MediaElementAudioNode.prototype.addOnTimeUpdateEventListener=function(a){this.source.addOnTimeUpdateEventListener(a)},snd.MediaElementAudioNode.prototype.removeOnTimeUpdateEventListener=function(a){return this.source.removeOnTimeUpdateEventListener(a)},snd.MediaElementAudioNode.prototype.addOnVolumeChangeEventListener=function(a){this.source.addOnVolumeChangeEventListener(a)},snd.MediaElementAudioNode.prototype.removeOnVolumeChangeEventListener=function(a){return this.source.removeOnVolumeChangeEventListener(a)},snd.MediaElementAudioNode.prototype.addOnWaitingEventListener=function(a){this.source.addOnWaitingEventListener(a)},snd.MediaElementAudioNode.prototype.removeOnWaitingEventListener=function(a){return this.source.removeOnWaitingEventListener(a)},snd.three.update=function(a){if(null==snd.SOUND_ENVIRONMENT.cameras[a.id])return void console.log("mainCamera("+a.toString()+") is not added.");if(null==snd.SOUND_ENVIRONMENT.cameras[a.id].listener.listener){for(var b in snd.SOUND_ENVIRONMENT.cameras)snd.SOUND_ENVIRONMENT.cameras[b].listener.resetListener();snd.SOUND_ENVIRONMENT.cameras[a.id].listener.setListener(snd.AUDIO_CONTEXT.listener)}for(var b in snd.SOUND_ENVIRONMENT.cameras){var c=snd.SOUND_ENVIRONMENT.cameras[b].camera,d=snd.SOUND_ENVIRONMENT.cameras[b].listener;snd.three.link(c,d)}for(var b in snd.SOUND_ENVIRONMENT.attaches)for(var e=snd.SOUND_ENVIRONMENT.attaches[b].object,f=0;f<snd.SOUND_ENVIRONMENT.attaches[b].sources.length;f++){var g=snd.SOUND_ENVIRONMENT.attaches[b].sources[f];snd.three.link(e,g)}},snd.three.addCamera=function(a){var b=a.id;if(null!=snd.SOUND_ENVIRONMENT.cameras[b])return void console.warn("snd.SOUND_ENVIRONMENT already has camera("+a.toString()+").");var c=new snd.Listener(null);snd.SOUND_ENVIRONMENT.cameras[b]={camera:a,listener:c},snd.SOUND_ENVIRONMENT.addListener(c)},snd.three.removeCamera=function(a){null!=snd.SOUND_ENVIRONMENT.cameras[a.id]&&(snd.SOUND_ENVIRONMENT.removeListener(snd.SOUND_ENVIRONMENT.cameras[a.id].listener),delete snd.SOUND_ENVIRONMENT.cameras[a.id])},snd.three.attach=function(a,b){var c=a.id;null==snd.SOUND_ENVIRONMENT.attaches[c]&&(snd.SOUND_ENVIRONMENT.attaches[c]={object:a,sources:[]}),snd.SOUND_ENVIRONMENT.attaches[c].sources.push(b),snd.SOUND_ENVIRONMENT.linkMap[b.id]=c},snd.three.detach=function(a){var b=a.id;if(null!=snd.SOUND_ENVIRONMENT.linkMap[b]){var c=snd.SOUND_ENVIRONMENT.linkMap[b],d=snd.SOUND_ENVIRONMENT.attaches[c].sources.indexOf(a);d>=0&&snd.SOUND_ENVIRONMENT.attaches[c].sources.splice(d,1),delete snd.SOUND_ENVIRONMENT.linkMap[b]}},snd.three.getSoundNodes=function(a){return snd.SOUND_ENVIRONMENT.attaches[a.id].sources},snd.three.link=function(a,b){if(!(isNaN(a.position.x)||isNaN(a.position.y)||isNaN(a.position.z)||isNaN(a.quaternion.x)||isNaN(a.quaternion.y)||isNaN(a.quaternion.z)||isNaN(a.quaternion.w))){var c=new THREE.Matrix4;c.copy(a.matrixWorld);var d=new THREE.Matrix4;d.copy(c),d.elements[12]=0,d.elements[13]=0,d.elements[14]=0;var e=new THREE.Vector3(c.elements[12],c.elements[13],c.elements[14]),f=new THREE.Vector3(-c.elements[8],-c.elements[9],-c.elements[10]),g=new THREE.Vector3;g.copy(a.up),g.applyMatrix4(d),b.setPosition(e.x,e.y,e.z),b.setOrientation(f.x,f.y,f.z,g.x,g.y,g.z)}},snd.three.util={},snd.three.util.createNodes=function(a,b,c,d){var e={};e.MediaElement=null!=a.MediaElement?snd.three.util.createMediaElementAudioNode(a.MediaElement,b,c):!1,null!=a.AudioBuffer?snd.three.util.createBufferSoundNodes(a.AudioBuffer,b,function(a){e.AudioBuffer=a,d(e)}):(e.AudioBuffer=null,d(e))},snd.three.util.createBufferSoundNodes=function(a,b,c){snd.util.createBufferSources(a,!1,function(a){var d={};for(var e in a)d[e]=new snd.BufferSoundNode(e,a[e]),b&&snd.MASTER.connectAudioUnit(d[e].id,d[e]);c(d)})},snd.three.util.createMediaElementSourceNodes=function(a,b,c){var d={},e={};for(var f in a)e[f+"_src"]=a[f];var g=snd.util.createMediaElementAudioSources(e,!1,c);for(var f in a)d[f]=new snd.MediaElementAudioNode(f,g[f+"_src"]),b&&snd.MASTER.connectAudioUnit(d[f].id,d[f]);return d};