/**
 * snd.js - The Sound Library for JavaScript with WebAudioAPI - v.1.0 beta
 * 
 * The MIT License (MIT)
 * copyright (c) 2014 - 2015 N_H <h.10x64@gmail.com>
 * 
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 * 
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 * 
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 * THE SOFTWARE.
 * 
 **/
snd.mml={version:.1,BETA:!0},snd.mml.DEFAULT_OCTAVE=4,snd.mml.DEFAULT_TEMPO=120,snd.mml.TEMPO="T",snd.mml.REST="R",snd.mml.OCTAVE="O",snd.mml.VALUE="L",snd.mml.OCTAVE_INC=">",snd.mml.OCTAVE_DEC="<",snd.mml.LOOP_START="[",snd.mml.LOOP_MID_END="/",snd.mml.LOOP_END="]",snd.mml.CHORD_START="(",snd.mml.CHORD_END=")",snd.mml.FAILED=-1,snd.mml.MMLPlayer=function(){this.stack=[],this.mmlStatus=new snd.mml.MMLStatus,this.buffer="",this.startEventListeners=[],this.stopEventListeners=[],this.noteOnEventListeners=[],this.noteOffEventListeners=[]},snd.mml.MMLPlayer.prototype.startMML=function(){this.mmlStatus=new snd.mml.MMLStatus,this.mmlStatus.play=!0;for(var a=0;a<this.startEventListeners.length;a++)this.startEventListeners[a].onMMLStart(this);this.next()},snd.mml.MMLPlayer.prototype.stopMML=function(){this.reset();for(var a=0;a<this.stopEventListeners.length;a++)this.stopEventListeners[a].onMMLStop(this)},snd.mml.MMLPlayer.prototype.addStartEventListener=function(a){this.startEventListeners.put(a)},snd.mml.MMLPlayer.prototype.removeStartEventListener=function(a){for(var b=0;b<this.startEventListeners.length;b++)if(this.startEventListeners[b]===a)return this.startEventListeners.splice(b,1),!0;return!1},snd.mml.MMLPlayer.prototype.addStopEventListener=function(a){this.stopEventListeners.push(a)},snd.mml.MMLPlayer.prototype.removeStopEventListener=function(a){for(var b=0;b<this.stopEventListeners.length;b++)if(this.stopEventListeners[b]===a)return this.stopEventListeners.splice(b,1),!0;return!1},snd.mml.MMLPlayer.prototype.addNoteOnEventListener=function(a){this.noteOnEventListeners.push(a)},snd.mml.MMLPlayer.prototype.removeNoteOnEventListener=function(a){for(var b=0;b<this.noteOnEventListeners.length;b++)if(a===this.noteOnEventListeners[b])return this.noteOnEventListeners.splice(b,1),!0;return!1},snd.mml.MMLPlayer.prototype.addNoteOffEventListener=function(a){this.noteOffEventListener.push(a)},snd.mml.MMLPlayer.prototype.removeNoteOffEventListener=function(a){for(var b=0;b<this.noteOffEventListeners.length;b++)if(a===this.noteOffEventListeners[b])return this.noteOffEventListeners.splice(b,1),!0;return!1},snd.mml.MMLPlayer.prototype.onNoteOn=function(a){for(var b=0;b<this.noteOnEventListeners.length;b++)this.noteOnEventListeners[b].onNoteOn(a)},snd.mml.MMLPlayer.prototype.onNoteOff=function(a){for(var b=0;b<this.noteOffEventListeners.length;b++)this.noteOffEventListeners[b].onNoteOff(a)},snd.mml.MMLPlayer.prototype.reset=function(){this.mmlStatus=new snd.mml.MMLStatus},snd.mml.MMLPlayer.prototype.next=function(){if(this.mmlStatus.play){if(this.mmlStatus.pos>=this.buffer.length)return void(this.mmlStatus.play=!1);var a,b=this.buffer.charAt(this.mmlStatus.pos).toUpperCase();if(console.log("MML : Command -> "+b),a=this.readLoop(this.mmlStatus.pos),a.status!=snd.mml.FAILED)return this.mmlStatus.pos=a.status,void this.next();if(a=this.readOption(this.mmlStatus.pos),a.status!=snd.mml.FAILED)return this.mmlStatus.pos=a.status,void this.next();if(a=this.readChord(this.mmlStatus.pos),a.status!=snd.mml.FAILED)return this.mmlStatus.pos=a.status,void a.result.on();" "!=b&&console.warn("MML : Unknown command -> "+b),this.mmlStatus.pos++,this.next()}},snd.mml.MMLPlayer.prototype.readOption=function(a){if(a>=this.buffer.length)return snd.mml.FAILED;var b,c=a,d=this.buffer.charAt(c).toUpperCase();return d===snd.mml.TEMPO?(c++,b=this.readNumber(c),b.status!=snd.mml.FAILED&&(this.mmlStatus.tempo=b.result),{status:b.status,result:null}):d===snd.mml.OCTAVE?(c++,b=this.readNumber(c),b.status!=snd.mml.FAILED&&(this.mmlStatus.octave=b.result),{status:b.status,result:null}):d===snd.mml.OCTAVE_INC?(c++,this.mmlStatus.octave++,{status:c,result:null}):d===snd.mml.OCTAVE_DEC?(c++,this.mmlStatus.octave--,{status:c,result:null}):d===snd.mml.VALUE?(c++,b=this.readNumber(c),b.status!=snd.mml.FAILED&&(this.mmlStatus.value=b.result),{status:b.status,result:null}):{status:snd.mml.FAILED,result:null}},snd.mml.MMLPlayer.prototype.readLoop=function(a){if(a>=this.buffer.length)return{status:snd.mml.FAILED,result:null};var b=this.buffer.charAt(a).toUpperCase();return b===snd.mml.LOOP_START?this.startLoop(a):b===snd.mml.LOOP_END?this.endLoop(a):b===snd.mml.LOOP_MID_END?this.breakLoop(a):{status:snd.mml.FAILED,result:null}},snd.mml.MMLPlayer.prototype.startLoop=function(a){return null==this.mmlStatus.loop&&(this.mmlStatus.loop=0),this.stack.push(new snd.mml.MMLStatus(this.mmlStatus.tempo,this.mmlStatus.octave,this.mmlStatus.value,this.mmlStatus.pos,this.mmlStatus.play,this.mmlStatus.loop,this.mmlStatus.loopEnd,this.mmlStatus.loopMax)),this.mmlStatus.loop=null,a++,{status:a,result:null}},snd.mml.MMLPlayer.prototype.breakLoop=function(a){a++;var b=this.readNumber(a),c=this.stack[this.stack.length-1];return b.status==snd.mml.FAILED?null!=c.loop&&c.loop+1==c.loopMax&&(a=c.loopEnd):b.result==c.loop&&(a=c.loopEnd),{status:a,result:null}},snd.mml.MMLPlayer.prototype.endLoop=function(a){var b=this.stack.pop();b.loopEnd=a,a++;var c=this.readNumber(a);return c.status==snd.mml.FAILED?this.mmlStatus=b:(b.loopMax=c.result,b.loop++,b.loop<c.result?this.mmlStatus=b:(this.mmlStatus.loop=null,this.mmlStatus.pos=c.status)),{status:this.mmlStatus.pos,result:null}},snd.mml.MMLPlayer.prototype.readChord=function(a){if(a>=this.buffer.length)return{status:snd.mml.FAILED,result:null};var b,c,d=a,e=this.buffer.charAt(d).toUpperCase();if(e===snd.mml.CHORD_START){var f;for(b=new snd.mml.Chord(this),this.addStopEventListener(b),d++;d<this.buffer.length&&(f=this.buffer.charAt(d).toUpperCase())!=snd.mml.CHORD_END;)console.log(f),c=this.readOption(d),c.status!=snd.mml.FAILED&&(d=c.status),c=this.readNote(d),c.status!=snd.mml.FAILED?(b.addNote(c.result.pitch,c.result.value),d=c.status):d++;return{status:d,result:b}}return c=this.readNote(d),c.status!=snd.mml.FAILED?(b=new snd.mml.Chord(this),this.addStopEventListener(b),b.addNote(c.result.pitch,c.result.value),d=c.status,{status:d,result:b}):{status:snd.mml.FAILED,result:null}},snd.mml.MMLPlayer.prototype.readNote=function(a){if(a>=this.buffer.length)return{status:snd.mml.FAILED,result:null};var b,c,d,e=a;switch(this.buffer.charAt(e).toUpperCase()){case"A":b=0;break;case"B":b=2;break;case"C":b=3;break;case"D":b=5;break;case"E":b=7;break;case"F":b=8;break;case"G":b=10;break;default:b=-1}return e++,0>b?{status:snd.mml.FAILED,result:null}:(d=this.readAccidental(e),d.status!=snd.mml.FAILED&&(b+=d.result,e=d.status),d=this.readNumber(e),d.status!=snd.mml.FAILED?(c=d.result,e=d.status):c=this.mmlStatus.value,{status:e,result:{pitch:b,value:c}})},snd.mml.MMLPlayer.prototype.readAccidental=function(a){if(a>=this.buffer.length)return{status:snd.mml.FAILED,result:null};for(var b=0,c=a;c<this.buffer.length;){var d=this.buffer.charAt(c).toUpperCase();if("#"===d||"+"===d)b++;else{if("-"!==d)break;b--}c++}return c==a?{status:snd.mml.FAILED,result:null}:{status:c,result:b}},snd.mml.MMLPlayer.prototype.readNumber=function(a){for(var b=a,c=a;c<this.buffer.length&&this.buffer.charAt(c).match(/\d/);)c++;if(b==c)return{status:snd.mml.FAILED,result:null};var d=this.buffer.substring(b,c);return{status:c,result:parseInt(d)}},snd.mml.MMLStatus=function(a,b,c,d,e,f,g,h){this.tempo=null==a?snd.mml.DEFAULT_TEMPO:a,this.octave=null==b?snd.mml.DEFAULT_OCTAVE:b,this.value=null==c?4:c,this.pos=null==d||0>d?0:d,this.play=null==e?!1:e,this.loop=f,this.loopEnd=g,this.loopMax=h},snd.mml.Chord=function(a){this.parent=a,this.notes={},this.minNote=null,this.stopTick=!1},snd.mml.Chord.prototype.addNote=function(a,b){var c=new snd.mml.Note(snd.mml.Note.getNoteId(),this,this.parent.mmlStatus,a,b);this.notes[c.id]=c,(null==this.minNote||this.minNote.sec>c.sec)&&(this.minNote=c)},snd.mml.Chord.prototype.on=function(){for(var a in this.notes)this.notes[a].on()},snd.mml.Chord.prototype.off=function(){for(var a in this.notes)this.notes[a].off()},snd.mml.Chord.prototype.onMMLStop=function(){this.stopTick=!0;for(var a in this.notes)this.notes[a].off()},snd.mml.Chord.prototype.onNoteOn=function(a){this.parent.onNoteOn(a)},snd.mml.Chord.prototype.onNoteOff=function(a){a!==this.minNote||this.stopTick||this.parent.next(),this.parent.onNoteOff(a)},snd.mml.Note=function(a,b,c,d,e){snd.OscillatorSource.apply(this,arguments),this.parent=b,this.tempo=c.tempo,this.octave=c.octave,this.pitch=d,this.value=e,this.setting()},snd.mml.Note.prototype=Object.create(snd.OscillatorSource.prototype),snd.mml.Note.prototype.constructor=snd.mml.Note,snd.mml.Note.prototype.on=function(){var a=this;snd.OscillatorSource.prototype.start.apply(this,arguments),setTimeout(function(){a.off()},1e3*this.sec),this.parent.onNoteOn(this)},snd.mml.Note.prototype.off=function(){snd.OscillatorSource.prototype.stop.apply(this,arguments),this.parent.onNoteOff(this)},snd.mml.Note.prototype.setting=function(){this.setFrequency(snd.util.noteToFrequency(this.octave,this.pitch)),this.sec=snd.util.noteToSec(this.tempo,this.value),snd.MASTER.connectAudioUnit(this.id,this)},snd.mml.Note.getNoteId=function(){return(new Date).getTime().toString()+Math.floor(9999*Math.random())};