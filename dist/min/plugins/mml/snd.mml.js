/**
 * snd.js - The Sound Library for JavaScript with WebAudioAPI - v.1.0 beta
 * 
 * The MIT License (MIT)
 * copyright (c) 2014 - 2015 N_H <h.10x64@gmail.com>
 * 
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 * 
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 * 
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 * THE SOFTWARE.
 * 
 **/
!function(a,b){"function"==typeof define&&define.amd?define(["snd.OscillatorSource"],b):"object"==typeof exports||(a.snd=b(a.snd))}(this,function(a){a.mml={version:.1,BETA:!0},a.mml.DEFAULT_OCTAVE=4,a.mml.DEFAULT_TEMPO=120,a.mml.TEMPO="T",a.mml.REST="R",a.mml.OCTAVE="O",a.mml.VALUE="L",a.mml.OCTAVE_INC=">",a.mml.OCTAVE_DEC="<",a.mml.LOOP_START="[",a.mml.LOOP_MID_END="/",a.mml.LOOP_END="]",a.mml.CHORD_START="(",a.mml.CHORD_END=")",a.mml.FAILED=-1,a.mml.MMLPlayer=function(){this.stack=[],this.mmlStatus=new a.mml.MMLStatus,this.buffer="",this.startEventListeners=[],this.stopEventListeners=[],this.noteOnEventListeners=[],this.noteOffEventListeners=[]},a.mml.MMLPlayer.prototype.startMML=function(){this.mmlStatus=new a.mml.MMLStatus,this.mmlStatus.play=!0;for(var b=0;b<this.startEventListeners.length;b++)this.startEventListeners[b].onMMLStart(this);this.next()},a.mml.MMLPlayer.prototype.stopMML=function(){this.reset();for(var a=0;a<this.stopEventListeners.length;a++)this.stopEventListeners[a].onMMLStop(this)},a.mml.MMLPlayer.prototype.addStartEventListener=function(a){this.startEventListeners.put(a)},a.mml.MMLPlayer.prototype.removeStartEventListener=function(a){for(var b=0;b<this.startEventListeners.length;b++)if(this.startEventListeners[b]===a)return this.startEventListeners.splice(b,1),!0;return!1},a.mml.MMLPlayer.prototype.addStopEventListener=function(a){this.stopEventListeners.push(a)},a.mml.MMLPlayer.prototype.removeStopEventListener=function(a){for(var b=0;b<this.stopEventListeners.length;b++)if(this.stopEventListeners[b]===a)return this.stopEventListeners.splice(b,1),!0;return!1},a.mml.MMLPlayer.prototype.addNoteOnEventListener=function(a){this.noteOnEventListeners.push(a)},a.mml.MMLPlayer.prototype.removeNoteOnEventListener=function(a){for(var b=0;b<this.noteOnEventListeners.length;b++)if(a===this.noteOnEventListeners[b])return this.noteOnEventListeners.splice(b,1),!0;return!1},a.mml.MMLPlayer.prototype.addNoteOffEventListener=function(a){this.noteOffEventListener.push(a)},a.mml.MMLPlayer.prototype.removeNoteOffEventListener=function(a){for(var b=0;b<this.noteOffEventListeners.length;b++)if(a===this.noteOffEventListeners[b])return this.noteOffEventListeners.splice(b,1),!0;return!1},a.mml.MMLPlayer.prototype.onNoteOn=function(a){for(var b=0;b<this.noteOnEventListeners.length;b++)this.noteOnEventListeners[b].onNoteOn(a)},a.mml.MMLPlayer.prototype.onNoteOff=function(a){for(var b=0;b<this.noteOffEventListeners.length;b++)this.noteOffEventListeners[b].onNoteOff(a)},a.mml.MMLPlayer.prototype.reset=function(){this.mmlStatus=new a.mml.MMLStatus},a.mml.MMLPlayer.prototype.next=function(){if(this.mmlStatus.play){if(this.mmlStatus.pos>=this.buffer.length)return void(this.mmlStatus.play=!1);var b,c=this.buffer.charAt(this.mmlStatus.pos).toUpperCase();if(console.log("MML : Command -> "+c),b=this.readLoop(this.mmlStatus.pos),b.status!=a.mml.FAILED)return this.mmlStatus.pos=b.status,void this.next();if(b=this.readOption(this.mmlStatus.pos),b.status!=a.mml.FAILED)return this.mmlStatus.pos=b.status,void this.next();if(b=this.readChord(this.mmlStatus.pos),b.status!=a.mml.FAILED)return this.mmlStatus.pos=b.status,void b.result.on();" "!=c&&console.warn("MML : Unknown command -> "+c),this.mmlStatus.pos++,this.next()}},a.mml.MMLPlayer.prototype.readOption=function(b){if(b>=this.buffer.length)return a.mml.FAILED;var c,d=b,e=this.buffer.charAt(d).toUpperCase();return e===a.mml.TEMPO?(d++,c=this.readNumber(d),c.status!=a.mml.FAILED&&(this.mmlStatus.tempo=c.result),{status:c.status,result:null}):e===a.mml.OCTAVE?(d++,c=this.readNumber(d),c.status!=a.mml.FAILED&&(this.mmlStatus.octave=c.result),{status:c.status,result:null}):e===a.mml.OCTAVE_INC?(d++,this.mmlStatus.octave++,{status:d,result:null}):e===a.mml.OCTAVE_DEC?(d++,this.mmlStatus.octave--,{status:d,result:null}):e===a.mml.VALUE?(d++,c=this.readNumber(d),c.status!=a.mml.FAILED&&(this.mmlStatus.value=c.result),{status:c.status,result:null}):{status:a.mml.FAILED,result:null}},a.mml.MMLPlayer.prototype.readLoop=function(b){if(b>=this.buffer.length)return{status:a.mml.FAILED,result:null};var c=this.buffer.charAt(b).toUpperCase();return c===a.mml.LOOP_START?this.startLoop(b):c===a.mml.LOOP_END?this.endLoop(b):c===a.mml.LOOP_MID_END?this.breakLoop(b):{status:a.mml.FAILED,result:null}},a.mml.MMLPlayer.prototype.startLoop=function(b){return null==this.mmlStatus.loop&&(this.mmlStatus.loop=0),this.stack.push(new a.mml.MMLStatus(this.mmlStatus.tempo,this.mmlStatus.octave,this.mmlStatus.value,this.mmlStatus.pos,this.mmlStatus.play,this.mmlStatus.loop,this.mmlStatus.loopEnd,this.mmlStatus.loopMax)),this.mmlStatus.loop=null,b++,{status:b,result:null}},a.mml.MMLPlayer.prototype.breakLoop=function(b){b++;var c=this.readNumber(b),d=this.stack[this.stack.length-1];return c.status==a.mml.FAILED?null!=d.loop&&d.loop+1==d.loopMax&&(b=d.loopEnd):c.result==d.loop&&(b=d.loopEnd),{status:b,result:null}},a.mml.MMLPlayer.prototype.endLoop=function(b){var c=this.stack.pop();c.loopEnd=b,b++;var d=this.readNumber(b);return d.status==a.mml.FAILED?this.mmlStatus=c:(c.loopMax=d.result,c.loop++,c.loop<d.result?this.mmlStatus=c:(this.mmlStatus.loop=null,this.mmlStatus.pos=d.status)),{status:this.mmlStatus.pos,result:null}},a.mml.MMLPlayer.prototype.readChord=function(b){if(b>=this.buffer.length)return{status:a.mml.FAILED,result:null};var c,d,e=b,f=this.buffer.charAt(e).toUpperCase();if(f===a.mml.CHORD_START){var g;for(c=new a.mml.Chord(this),this.addStopEventListener(c),e++;e<this.buffer.length&&(g=this.buffer.charAt(e).toUpperCase())!=a.mml.CHORD_END;)console.log(g),d=this.readOption(e),d.status!=a.mml.FAILED&&(e=d.status),d=this.readNote(e),d.status!=a.mml.FAILED?(c.addNote(d.result.pitch,d.result.value),e=d.status):e++;return{status:e,result:c}}return d=this.readNote(e),d.status!=a.mml.FAILED?(c=new a.mml.Chord(this),this.addStopEventListener(c),c.addNote(d.result.pitch,d.result.value),e=d.status,{status:e,result:c}):{status:a.mml.FAILED,result:null}},a.mml.MMLPlayer.prototype.readNote=function(b){if(b>=this.buffer.length)return{status:a.mml.FAILED,result:null};var c,d,e,f=b;switch(this.buffer.charAt(f).toUpperCase()){case"A":c=0;break;case"B":c=2;break;case"C":c=3;break;case"D":c=5;break;case"E":c=7;break;case"F":c=8;break;case"G":c=10;break;default:c=-1}return f++,0>c?{status:a.mml.FAILED,result:null}:(e=this.readAccidental(f),e.status!=a.mml.FAILED&&(c+=e.result,f=e.status),e=this.readNumber(f),e.status!=a.mml.FAILED?(d=e.result,f=e.status):d=this.mmlStatus.value,{status:f,result:{pitch:c,value:d}})},a.mml.MMLPlayer.prototype.readAccidental=function(b){if(b>=this.buffer.length)return{status:a.mml.FAILED,result:null};for(var c=0,d=b;d<this.buffer.length;){var e=this.buffer.charAt(d).toUpperCase();if("#"===e||"+"===e)c++;else{if("-"!==e)break;c--}d++}return d==b?{status:a.mml.FAILED,result:null}:{status:d,result:c}},a.mml.MMLPlayer.prototype.readNumber=function(b){for(var c=b,d=b;d<this.buffer.length&&this.buffer.charAt(d).match(/\d/);)d++;if(c==d)return{status:a.mml.FAILED,result:null};var e=this.buffer.substring(c,d);return{status:d,result:parseInt(e)}},a.mml.MMLStatus=function(b,c,d,e,f,g,h,i){this.tempo=null==b?a.mml.DEFAULT_TEMPO:b,this.octave=null==c?a.mml.DEFAULT_OCTAVE:c,this.value=null==d?4:d,this.pos=null==e||0>e?0:e,this.play=null==f?!1:f,this.loop=g,this.loopEnd=h,this.loopMax=i},a.mml.Chord=function(a){this.parent=a,this.notes={},this.minNote=null,this.stopTick=!1},a.mml.Chord.prototype.addNote=function(b,c){var d=new a.mml.Note(a.mml.Note.getNoteId(),this,this.parent.mmlStatus,b,c);this.notes[d.id]=d,(null==this.minNote||this.minNote.sec>d.sec)&&(this.minNote=d)},a.mml.Chord.prototype.on=function(){for(var a in this.notes)this.notes[a].on()},a.mml.Chord.prototype.off=function(){for(var a in this.notes)this.notes[a].off()},a.mml.Chord.prototype.onMMLStop=function(){this.stopTick=!0;for(var a in this.notes)this.notes[a].off()},a.mml.Chord.prototype.onNoteOn=function(a){this.parent.onNoteOn(a)},a.mml.Chord.prototype.onNoteOff=function(a){a!==this.minNote||this.stopTick||this.parent.next(),this.parent.onNoteOff(a)},a.mml.Note=function(b,c,d,e,f){a.OscillatorSource.apply(this,arguments),this.parent=c,this.tempo=d.tempo,this.octave=d.octave,this.pitch=e,this.value=f,this.setting()},a.mml.Note.prototype=Object.create(a.OscillatorSource.prototype),a.mml.Note.prototype.constructor=a.mml.Note,a.mml.Note.prototype.on=function(){var b=this;a.OscillatorSource.prototype.start.apply(this,arguments),setTimeout(function(){b.off()},1e3*this.sec),this.parent.onNoteOn(this)},a.mml.Note.prototype.off=function(){a.OscillatorSource.prototype.stop.apply(this,arguments),this.parent.onNoteOff(this)},a.mml.Note.prototype.setting=function(){this.setFrequency(a.util.noteToFrequency(this.octave,this.pitch)),this.sec=a.util.noteToSec(this.tempo,this.value),a.MASTER.connectAudioUnit(this.id,this)},a.mml.Note.getNoteId=function(){return(new Date).getTime().toString()+Math.floor(9999*Math.random())}});