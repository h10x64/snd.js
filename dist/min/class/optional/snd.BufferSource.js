/**
 * snd.js - The Sound Library for JavaScript with WebAudioAPI - v.1.0 beta
 * 
 * The MIT License (MIT)
 * copyright (c) 2014 - 2015 N_H <h.10x64@gmail.com>
 * 
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 * 
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 * 
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 * THE SOFTWARE.
 * 
 **/
define(["snd.Source","snd.util","snd.AudioDataManager"],function(a){return a.BufferSource=function(){a.Source.apply(this,arguments),this._source=null,this.audioBuffer=null,this._key="",Object.defineProperties(this,{loop:{get:function(){return this._status.loop},set:function(a){this._source&&a&&(this._source.loop=a,this._status.loop=a)}},loopStart:{get:function(){return this._status.loopStart},set:function(a){var b=parseFloat(a);this._source&&b&&(this._source.loopStart=b,this._status.loopStart=b)}},loopEnd:{get:function(){return this._status.loopEnd},set:function(a){var b=parseFloat(a);null!=this._source&&null!=b&&(this._source.loopEnd=b,this._status.loopEnd=b)}}}),this._eventListeners={onended:[],onload:[]}},a.BufferSource.prototype=Object.create(a.Source.prototype),a.BufferSource.prototype.constructor=a.BufferSource,a.BufferSource.CLASS_NAME="snd.BufferSource",a.BufferSource.REGEX_KEY=/^key:(.*)$/,a.BufferSource.prototype.start=function(b,c,d){null!=this._source&&this.status==a.status.READY?(null==b?this._source.start(0):null==c?this._source.start(b):null==d?this._source.start(b,c):this._source.start(b,c,d),this._status.status=a.status.STARTED):null!=this.audioBuffer&&(this.status==a.status.STARTED?(this.stop(0),this._status.status=a.status.STOPPED):this.setAudioBuffer(this.audioBuffer),this.start(b,c,d))},a.BufferSource.prototype.stop=function(b){null!=this._source&&this.status==a.status.STARTED&&this._source.stop(null==b?0:b)},a.BufferSource.prototype.setLoop=function(a){this.loop=a},a.BufferSource.prototype.getLoop=function(){return this.loop},a.BufferSource.prototype.setLoopStart=function(a){this.loopStart=a},a.BufferSource.prototype.getLoopStart=function(){return this.loopStart},a.BufferSource.prototype.setLoopEnd=function(a){this.loopEnd=a},a.BufferSource.prototype.getLoopEnd=function(){return this.loopEnd},a.BufferSource.prototype.loadURL=function(b){var c=this;this._status.src=b;var d=a.AUDIO_DATA_MANAGER.getAudioBuffer(b);d?(this.setAudioBuffer(d),c.fireOnLoadEvent()):(this._key=b,a.AUDIO_DATA_MANAGER.add(this._key,b),a.AUDIO_DATA_MANAGER.addOnLoadListener(this._key,function(){var b=a.AUDIO_DATA_MANAGER.getAudioBuffer(c._key);c.setAudioBuffer(b),c.fireOnLoadEvent()}),a.AUDIO_DATA_MANAGER.load(this._key))},a.BufferSource.prototype.loadBase64=function(b){var c=this;this._status.src=null!=a.util.REGEX_DATA_URI_SCHEME.exec(b)?b:"data:audio/unknown;base64,"+b,this._key=a.util.getNewKey(this.id),a.AUDIO_DATA_MANAGER.addBase64(this._key,b),a.AUDIO_DATA_MANAGER.addOnLoadListener(this._key,function(){var b=a.AUDIO_DATA_MANAGER.getAudioBuffer(c._key);c.setAudioBuffer(b),c.fireOnLoadEvent()}),a.AUDIO_DATA_MANAGER.load(this._key)},a.BufferSource.prototype.loadAudioBuffer=function(b){this._status.src="key:"+b;var c=a.AUDIO_DATA_MANAGER.getAudioBuffer(b);this.setAudioBuffer(c),this.fireOnLoadEvent()},a.BufferSource.prototype.setAudioBuffer=function(b){this.audioBuffer=b;var c=a.AUDIO_CONTEXT.createBufferSource();null!=this._source&&this._source.disconnect(this._gain),delete this._source,this._source=c,this._source.buffer=this.audioBuffer,this._source.connect(this._gain),this.resetEventMethods(this._source),this._source.loop=this.loop,null!=this.loopStart&&(this._source.loopStart=this.loopStart),null!=this.loopEnd&&(this._source.loopEnd=this.loopEnd),this._status.status=a.status.READY},a.BufferSource.prototype.addOnEndedEventListener=function(a){this._eventListeners.onended.push(a)},a.BufferSource.prototype.removeOnEndedEventListener=function(a){var b=this._eventListeners.onended.indexOf(a);return b>0?(this._eventListeners.onended.splice(b),!0):!1},a.BufferSource.prototype.fireOnEndedEvent=function(){var a=this,b=this._eventListeners.onended;for(i=0;i<b.length;i++)b[i].onended(a)},a.BufferSource.prototype.addOnLoadEventListener=function(a){this._eventListeners.onload.push(a)},a.BufferSource.prototype.removeOnLoadEventListener=function(a){var b=this._eventListeners.onload.indexOf(a);return b>0?(this._eventListeners.onload.splice(i,1),!0):!1},a.BufferSource.prototype.fireOnLoadEvent=function(){var a=this,b=this._eventListeners.onload;for(i=0;i<b.length;i++)b[i].onload(a)},a.BufferSource.prototype.resetEventMethods=function(){var b=this;this._source.onended=function(){b._status.status=a.status.STOPPED,b.fireOnEndedEvent()}},a.BufferSource.prototype.createStatus=function(){return new a.BufferSource.Status},a.BufferSource.prototype.toJSON=function(){return this._status},a.BufferSource.prototype.loadData=function(b){a.Source.prototype.loadData.apply(this,arguments);var c=a.util.REGEX_DATA_URI_SCHEME.exec(b.src),d=a.BufferSource.REGEX_KEY.exec(b.src);null!=c?this.loadBase64(b.src):null!=d?this.loadAudioBuffer(d[1]):b.src&&this.loadURL(b.src),1==b.loop&&(this.loop=!0),this.loopStart=b.loopStart,this.loopEnd=b.loopEnd},a.BufferSource.loadJSON=function(b){var c=JSON.parse(b);if(c.className!=a.BufferSource.CLASS_NAME)throw new a.Exception(c.id+" is not instance of 'snd.BufferSource' class.");var d=new a.BufferSource("");return d.loadData(c),d},a.BufferSource.Status=function(){a.Source.Status.apply(this,arguments),this.className="snd.BufferSource",this.type=a.srctype.AUDIO_BUFFER,this.loop=!1,this.loopStart=null,this.loopEnd=null,this.src=""},a.util.createBufferSources=function(b,c,d){if(!a.BufferSource)throw new a.Exception("Please load snd.BufferSource.js");var e={},f={};for(var g in b){var h=b[g];null==e[h]&&(e[h]=[]);var i=new a.BufferSource(g);e[h].push(i)}for(var h in e)f[h]=h;a.AUDIO_DATA_MANAGER.addAll(f);var j=function(){var b={};for(var f in e)for(var g=0;g<e[f].length;g++)e[f][g].loadAudioBuffer(f),b[e[f][g].id]=e[f][g],c&&a.MASTER.connectAudioUnit(e[f][g].id,e[f][g]);a.AUDIO_DATA_MANAGER.removeAllDataLoadListener(j),d(b)};a.AUDIO_DATA_MANAGER.addAllDataLoadListener(j),a.AUDIO_DATA_MANAGER.load()},a});