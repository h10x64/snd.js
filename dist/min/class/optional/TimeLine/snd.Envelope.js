/**
 * snd.js - The Sound Library for JavaScript with WebAudioAPI - v.1.0 beta
 * 
 * The MIT License (MIT)
 * copyright (c) 2014 - 2015 N_H <h.10x64@gmail.com>
 * 
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 * 
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 * 
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 * THE SOFTWARE.
 * 
 **/
!function(a,b){"function"==typeof define&&define.amd?define(["snd.TimeLineEvent","snd.TimeValue"],b):"object"==typeof exports||(a.snd=b(a.snd))}(this,function(a){return a.Envelope=function(b,c){a.TimeLineEvent.call(this,b,c,0,1/0),this._timeValueChangeEventListeners=[],this._timeValueAddEventListeners=[],this._timeValueRemoveEventListeners=[],Object.defineProperties(this,{length:{get:function(){return this._envelope.length}}}),this._envelope=[]},a.Envelope.prototype=Object.create(a.TimeLineEvent.prototype),a.Envelope.prototype.constructor=a.Envelope,a.Envelope.prototype.start=function(b,c){if(this._target&&this._status!=a.status.STARTED){var d=this.startTime-b,e=0>d?0:d,f=0>d?Math.abs(d):0,g=this.endTime-this.startTime-f;this.setEnvelope(e,f,g,null==c?a.CURRENT_TIME:c),this._status=a.status.STARTED,"function"==typeof this.target.addOnEndedEventListener?this.target.addOnEndedEventListener(this.receiveOnEndedEvent):this._timerID=setTimeout(function(b){b.status=a.status.READY}(_this),g),this.fireStartEvent()}},a.Envelope.prototype.get=function(a){return this._envelope[a]},a.Envelope.prototype.push=function(b){b.addTimeValueChangeEventListener(this.receiveTimeValueChangeEvent),this._envelope.push(b),this._envelope.sort(a.Envelope.compareTimeValueArray),this.fireTimeValueAddEvent(this,b)},a.Envelope.prototype.indexOf=function(a){return this._envelope.indexOf(a)},a.Envelope.prototype.remove=function(a){var b=this._envelope.indexOf(a);b>=0&&this.splice(b,1)},a.Envelope.prototype.splice=function(a,b){if(a>0){var c=this._envelope[a];c.removeTimeValueChangeEventListener(this.receiveTimeValueChangeEvent),this._envelope.splice(a,b),this.fireTimeValueRemoveEvent(this,c)}},a.Envelope.prototype.onTimeValueChanged=function(){},a.Envelope.prototype.onTimeValueAdded=function(){},a.Envelope.prototype.onTimeValueRemoved=function(){},a.Envelope.prototype.addTimeValueChangeEventListener=function(a){this._timeValueChangeEventListeners.push(a)},a.Envelope.prototype.removeTimeValueChangeEventListener=function(a){var b=this._timeValueChangeEventListeners.indexOf(a);b>=0&&this._timeValueChangeEventListeners.splice(b,1)},a.Envelope.prototype.addTimeValueRemoveEventListener=function(a){this._timeValueRemoveEventListeners.push(a)},a.Envelope.prototype.removeTimeValueRemoveEventListener=function(a){var b=this._timeValueRemoveEventListeners.indexOf(a);b>=0&&this._timeValueRemoveEventListeners.splice(b,1)},a.Envelope.prototype.fireTimeValueChangeEvent=function(a,b,c,d){this.onTimeValueChanged(a,b,c,d);for(var e in this._timeValueChangeEventListeners)e(a,b,c,d)},a.Envelope.prototype.fireTimeValueAddEvent=function(a,b){this.onTimeValueAdded(a,b);for(var c in this._timeValueAddEventListeners)c(a,b)},a.Envelope.prototype.fireTimeValueRemoveEvent=function(a,b){this.onTimeValueRemoved(a,b);for(var c in this._timeValueRemoveEventListeners)c(a,b)},a.Envelope.prototype.receiveTimeValueChangeEvent=function(b,c,d){var e=this._envelope.indexOf(b);e>=0&&(e-1>0&&this._envelope[e].time<this._envelope[e-1]?this._envelope.sort(a.Envelope.compareTimeValueArray):e+1<this._envelope.length&&this._envelope[e]>this._envelope[e+1]&&this._envelope.sort(a.Envelope.compareTimeValueArray)),this.fireTimeValueChangeEvent(this,b,c,d)},a.Envelope.prototype.setEnvelope=function(a,b,c,d){if(this._envelope.length>0){var e=this.calcSetTime(b);this.setEnvelopeToTarget(d,a,b,e.index,e.left)}},a.Envelope.prototype.calcSetTime=function(a){var b,c;if(a<=this._envelope[0].time)b=0,c={time:a,value:this._envelope[0].value};else if(this._envelope[this._envelope.length-1].time<=a)b=this._envelope.length,c=this._envelope[b-1];else{var d=null,e=null,f=null;for(b=0;b<this._envelope.length;b++){if(this._envelope[b].time==a){f=this._envelope[b],b++;break}if(this._envelope[b].time>a){d=this._envelope[b-1],e=this._envelope[b],f={time:a,value:e.value+(e.value-d.value)*(a-d.time)/(e.time-d.time)};break}}c=f}return{index:b,left:c}},a.Envelope.prototype.setEnvelopeToTarget=function(a,b,c,d,e){var f=a+b;if(this._target.cancelScheduledValues(0),d>=this._envelope.length)return void this._target.setValueAtTime(e.value,f);this._target.setValueAtTime(e.value,f);for(var g=d;g<this._envelope.length;g++){var h=this._envelope[g];this._target.linearRampToValueAtTime(h.value,f+h.time-c)}},a.Envelope.compareTimeValueArray=function(a,b){return a&&a.time?b&&b.time?a.time<b.time?-1:a.time==b.time?0:1:1:-1},a});